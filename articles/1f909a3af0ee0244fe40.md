---
title: "OASä½¿ã£ã¦ãªã‚‹ã¹ãæ¥½ã«Nuxtã®ãƒ†ã‚¹ãƒˆ"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['typescript', 'axios', 'OpenAPI', 'OAS', 'nuxt']
published: true
---
# ã¯ã˜ã‚ã«
[composition api](https://v3.vuejs.org/guide/composition-api-introduction.html)ã®ç™»å ´ã§Vueã‚‚ã‚ˆã†ã‚„ããƒ†ã‚¹ãƒˆã—ã‚„ã™ã„æ„Ÿã˜ã«ãªã£ã¦ãã¾ã—ãŸã€‚
ã¨ã¯ã„ãˆå®Ÿéš›AJAXãŒçµ¡ã‚“ã ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’ã‚„ã‚ã†ã¨ã™ã‚‹ã¨ã‚ã‚Œã‚’ãƒ¢ãƒƒã‚¯ã—ã¦ã“ã‚Œã‚‚ãƒ¢ãƒƒã‚¯ã—ã¦ã¨ãªã‚“ã ã‹ã‚“ã å¤§é‡ã®ãƒ¢ãƒƒã‚­ãƒ³ã‚°ãŒå¿…è¦ã«ãªã£ã¦è‰²ã€…ã‚ã‚“ã©ãã•ã„æ„Ÿã˜ã«ãªã‚ŠãŒã¡ã§ã™ã—ã€ã»ã¨ã‚“ã©ãƒ¢ãƒƒã‚¯ã•ã‚Œã¦ã¦å®Ÿéš›ã®ã¨ã“ã‚ã©ã“ãŒãƒ†ã‚¹ãƒˆã§ãã¦ã‚‹ã®ã‹ã‚ã‘ãŒã‚ã‹ã‚‰ãªã„æ„Ÿã˜ã«ãªã‚ŠãŒã¡ã§ã™ã€‚
[å‰å›ã®è¨˜äº‹](https://zenn.dev/okoha/articles/b877ff1163f5c7)ã§ã¯OASã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã‚¹ã‚¿ãƒ–ã‚µãƒ¼ãƒãƒ¼ãŒç”¨æ„ã§ãã‚‹ã“ã¨ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ã§ã¯ãã®ã‚¹ã‚¿ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ©ç”¨ã—ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã§å†ç¾æ€§ã®ã‚ã‚‹AJAXãƒ†ã‚¹ãƒˆã‚’ç°¡å˜ã«è¡Œãˆã‚‹æ–¹æ³•ãŒãªã„ã‹æ¨¡ç´¢ã—ã¦ã¿ã¾ã™ã€‚
ã‚¹ã‚¿ãƒ–ã‚µãƒ¼ãƒãƒ¼ã®åˆ©ç”¨è‡ªä½“ã¯ãƒ•ãƒ­ãƒ³ãƒˆãŒã©ã‚“ãªå®Ÿè£…ã‚’ã—ã¦ã„ã‚ˆã†ãŒã‚ã¾ã‚Šé–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ãŒã€ä»Šå›ã¯Nuxtã‚’ä¾‹ã«ã¨ã£ã¦èª¬æ˜ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## ã‚µãƒãƒªãƒ¼
- å‡ºæ¥ãŸã“ã¨
    - jestã§`mutation`ã‚„`action`ã‚’æ“ä½œã—ã¦ãã®çµæœã‚’åæ˜ ã—ãŸçŠ¶æ…‹ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ãƒ†ã‚¹ãƒˆ
    - ajaxã—ã¦ã‚‹vuexã®`action`ã‚’ãƒ†ã‚¹ãƒˆ
    - [useFetch](https://composition-api.nuxtjs.org/lifecycle/useFetch)ã—ãŸçµæœã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆ
    - [asyncData](https://composition-api.nuxtjs.org/API/useAsync)ã—ãŸçµæœã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆ
    - github actionsä¸Šã§ã‚¹ã‚¿ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ©ç”¨ã—ãŸajaxã‚’å«ã‚€CIãƒ†ã‚¹ãƒˆ
- å‡ºæ¥ãªã‹ã£ãŸã“ã¨
    - nuxtè‡ªä½“ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¡ã‚ƒã£ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å®Œå…¨ã«å†ç¾ï¼ˆä½•æ•…ã‹jestã§ã‚„ã‚ã†ã¨ã™ã‚‹ã¨tsãƒ‘ãƒ¼ã‚µãƒ¼ãŒã¡ã‚ƒã‚“ã¨å‹•ã‹ãªã‹ã£ãŸã®ã§å¤šåˆ†ç§ã®è¨­å®šãŒæ‚ªã‹ã£ãŸï¼‰
- è©¦ã—ã¦ãªã„ã‹ã‚‰ã§ãã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã“ã¨
    - [vuex-module-decorators](https://github.com/championswimmer/vuex-module-decorators)ãŒä½¿ã‚ã‚Œã¦ã„ãªã„ãƒ¬ã‚¬ã‚·ãƒ¼ãªvuexã§ã®å‹•ä½œç¢ºèª
    - [puppeteer](https://github.com/puppeteer/puppeteer)ã§E2Eï¼ˆå¤šåˆ†ã§ãã‚‹ã¨æ€ã†ï¼‰

## å®Œæˆå“
https://github.com/kmatsui058/nuxt-jest-sample

# ã“ã‚“ãªã®ãŒã§ãã¾ã—ãŸ
ã©ã†ã‚„ã£ã¦ä½œã‚‹ã‹è©±ã™ã¨é•·ããªã‚‹ã®ã§ã€å…ˆã«å®Œæˆç³»ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

```ts:ProjectComponent.spec.ts
import { mount } from '@vue/test-utils'
import { createStore } from '~/.nuxt/store'
import { authStore, initialiseStores } from '~/utils/store-accessor'
import Projects from '@/components/ProjectsComponent.vue'

describe('projects component', () => {
  beforeEach(() => {
    initialiseStores(createStore()) // storeã‚’ãƒ†ã‚¹ãƒˆã®åº¦ã«åˆæœŸåŒ–ã™ã‚‹
  })
  describe('projects', () => {
    test('mount test', async () => {

      await authStore.fetchSelf() // actionã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãŠã

      const wrapper = mount(Projects, {
        mocks: {
          $nuxt: {
            context: {}, // useFetchã‚’å‹•ã‹ã™ãŸã‚ã«ç©ºã£ã½ã§è‰¯ã„ã®ã§$nuxtã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹
          },
        },
      })

      await (wrapper.vm as any).fetch() // useFetchã‚’æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹

      const nameElement = wrapper.find('div.name').element
      expect(nameElement.innerHTML).toBe('admin') // ajaxã§è¨­å®šã—ãŸå€¤ãŒæ ¼ç´ã•ã‚Œã¦ã‚‹ã“ã¨ã‚’ç¢ºèª
      const projectNameElement = wrapper.find('div.project-name').element
      expect(projectNameElement.innerHTML).toBe('ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ') // ajaxã§è¨­å®šã—ãŸå€¤ãŒæ ¼ç´ã•ã‚Œã¦ã‚‹ã“ã¨ã‚’ç¢ºèª
    })
  })
})

```


```vue:@/components/ProjectsComponent.vue
<template>
  <div>
    <User /> // â€»Userã¯ç›´æ¥vuexã®getterã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã‚‹ã®ã§propsç„¡ã—
    <Project
      v-for="(project, index) in projects"
      :key="index"
      :project-name="project.name"
    />
  </div>
</template>

<script lang="ts">
import { defineComponent, useFetch, ref, Ref } from '@nuxtjs/composition-api'
import User from '~/components/User.vue'
import Project from '~/components/Project.vue'
import { projectsStore } from '~/store'
import { ProjectItem } from '~/oas'
export default defineComponent({
  name: 'ProjectsComponent',
  components: {
    User,
    Project,
  },
  setup() {
    const projects: Ref<ProjectItem[]> = ref([])
    const { fetch } = useFetch(async () => {  // â€»jestã§fetchå®Œäº†ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«æ‰‹å‹•fetchã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã
      await projectsStore.fetchProjects()
      projects.value = projectsStore.getProjects
    })
    fetch()  // ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç”¨ã«å³åº§ã«fetchã‚’å®Ÿè¡Œã—ã¦ãŠã
    return { projects, fetch }  // jestã‹ã‚‰vmçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«fetchã‚’returnã—ã¦ãŠã
  },
})
</script>
```

```ts:~/store/auth.ts
import { Module, VuexModule, Mutation, Action } from 'vuex-module-decorators'
import { AxiosResponse } from 'axios'
import { $apiConfig } from '@/plugins/api-accessor'
import { DefaultApi, UserData } from '~/oas'

@Module({
  name: 'auth',
  stateFactory: true,
  namespaced: true,
  preserveState: true,
})
export default class AuthModule extends VuexModule {
  private self: UserData | null = null

  get getSelf(): UserData | null {
    return this.self
  }

  @Mutation
  setSelf(value: UserData | null): void {
    this.self = value
  }

  @Action
  async fetchSelf(): Promise<void> {
    const res: AxiosResponse<UserData> = await new DefaultApi(
      $apiConfig
    ).apiV2UsersMyselfGet()
    this.setSelf(res.data)
  }
}

```

`shallowMount`ã§ã¯ãªã`mount`ã‚’ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã®ãƒ†ã‚¹ãƒˆä¸€ã¤ã§ï¼“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨vuexãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æœ€ä½é™ã®å‹•ä½œç¢ºèªã‚’ä¸€æ°—ã«è¡Œã£ã¦ã„ã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“ã“ã‚“ãªé¢¨ã«ç°¡å˜ã«ãƒ†ã‚¹ãƒˆã§ãã‚‹ã®ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç¶ºéº—ãªæ™‚ã ã‘ã§ã™ãŒã€å¤§åˆ†ãƒ¢ãƒƒã‚­ãƒ³ã‚°ã—ãªã„ã¨ãªã‚‰ãªã„éƒ¨åˆ†ãŒæ¸›ã£ã¦ã„ã¦ã€ã“ã‚Œãã‚‰ã„ãªã‚‰ã‚ã‚“ã©ãã•ãŒã‚Šã•ã‚“ã§ã‚‚ãƒ†ã‚¹ãƒˆæ›¸ã„ã¦ã¿ã‚ˆã†ã‹ãªã¨ãªã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ãã‚Œã§ã¯ä»•è¾¼ã¿ã®æ–¹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

# OASå´ã®ä»•è¾¼ã¿
## ã‚¹ã‚¿ãƒ–ã‚µãƒ¼ãƒãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
ã¾ãšã‚¹ã‚¿ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’ç”¨æ„ã—ã¾ã™ã€‚ç‰¹ã«ã“ã ã‚ã‚ŠãŒç„¡ã‘ã‚Œã°é©å½“ã«[apisprout](https://github.com/danielgtaylor/apisprout)ã‚’docker-composeã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
```yaml:docker-compose.yaml
version: '3'

services:
  stub:
    image: danielgtaylor/apisprout:latest
    ports:
      - '8000:8000'
    volumes:
      - ./openapi.yaml:/openapi.yaml
    entrypoint: /usr/local/bin/apisprout /openapi.yaml --watch
```
## AJAXå…ˆã®åˆ‡ã‚Šæ›¿ãˆ
ç¶šã„ã¦ãƒ•ãƒ­ãƒ³ãƒˆå´ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã¨ã‚¹ã‚¿ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ä¾‹ãˆã°é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒ3000ã§ã‚ãŒã£ã¦ã‚‹ã¨ã™ã‚Œã°
```toml:.env
USE_STUB=true
STUB_PATH=http://localhost:8000
API_PATH=http://localhost:3000
```
ã®ã‚ˆã†ãªenvãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã€[dotenv](https://www.npmjs.com/package/dotenv)ï¼ˆnuxtã§ã‚ã‚Œã°[@nuxtjs/dotenv](https://github.com/nuxt-community/dotenv-module)ï¼‰ã‚’åˆ©ç”¨ã—ã¦axiosã§å©ããŸã‚ã®basePathã‚’
```ts
  const basePath =
    process.env.USE_STUB === 'true'
      ? process.env.STUB_PATH
      : process.env.API_PATH,
```
ã®ã‚ˆã†ã«ã—ã¦ç”¨æ„ã—ã¦ãŠãã¾ã™ã€‚
ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹axiosã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ¸¡ã—ã€`.env`ã®`USE_STUB`ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã¨ã‚¹ã‚¿ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## Open api generatorã®typescript-axiosãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å°å…¥
å‰å›ã®è¨˜äº‹ã§ç´¹ä»‹ã—ã¾ã—ãŸãŒã€OASã®ã‚¹ã‚­ãƒ¼ãƒãŒãã¡ã‚“ã¨ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°ts-axiosãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
ã¾ãš[javaã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ](https://www.java.com/ja/download/)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰[@openapitools/openapi-generator-cli](https://github.com/OpenAPITools/openapi-generator)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```
npm install @openapitools/openapi-generator-cli -D
```
ç¶šã„ã¦`package.json`ã«generatorå®Ÿè¡Œç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
```json
{
  "scripts": {
    "oas": "openapi-generator-cli generate --enable-post-process-file -i ./openapi.yaml -o ./oas --generator-name typescript-axios"
  },
}
```
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨oasã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ã«axiosã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
ã“ã®ç”Ÿæˆã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ç¬¬ä¸‰å¼•æ•°ã«axiosã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¸¡ã›ã¾ã™ã®ã§ã€å¿…è¦ã§ã‚ã‚Œã°nuxtå´ã®`$axios`ã‚’æ¸¡ã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
ç‰¹ã«nuxtç‰¹æœ‰ã®axiosæ©Ÿèƒ½ã‚’ä½¿ã†ã¤ã‚‚ã‚ŠãŒç„¡ã‘ã‚Œã°oasã§generateã—ãŸã‚‚ã®ã ã‘ä½¿ã†ã§å•é¡Œã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
ã¨ã¯ã„ãˆnuxtã®`$axios`ã‚’æ¸¡ã•ãªãã¦ã‚‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å˜ä½“ã§ä½¿ãˆã‚‹ã®ã§ã€ãã®ã¾ã¾ä½¿ã£ã¦ãŠã‘ã°jestã§ã®ãƒ†ã‚¹ãƒˆã§ã„ã¡ã„ã¡ãƒ¢ãƒƒã‚­ãƒ³ã‚°ã—ãªãã¦ã™ã‚“ã§ä¾¿åˆ©ã§ã™ã€‚
è©³ã—ã„ä½¿ã„æ–¹ã¯ãƒªãƒã‚¸ãƒˆãƒªã®æ–¹ã‚’ã”è¦§ãã ã•ã„ã€‚

## CIã¸ã®çµ„ã¿è¾¼ã¿
ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ä½œç¢ºèªãŒã§ããŸã‚‰CIã«çµ„ã¿è¾¼ã¿ã¾ã—ã‚‡ã†ã€‚envã‚’è¿½åŠ ã—ã¦`docker-compose up -d`ã¨`yarn test`ã‚’è¿½åŠ ã—ã¾ã™ã€‚
github actionsã ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚é©å®œç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
```yml:.github/workflows/ci.yml

jobs:
  ci:
    env:
      USE_STUB: "true"
      STUB_PATH: http://localhost:8000
      API_PATH: http://localhost:3000

    steps:
        ~~
      - name: docker-up
        run: docker-compose up -d
        ~~
      - name: Run build
        run: yarn build
    ã€€- name: Run tests
        run: yarn test
        ~~
```
ãªãŠä»Šå›ä¾‹ã§ä½œã£ã¦ã„ã‚‹ã‚ˆã†ãª`.nuxt`ã®ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã§ä½¿ã†å ´åˆã¯ã€testã®å‰ã«å¿…ãšbuildã—ã¦`.nuxt`ã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

# nuxtå´ã¸ã®ä»•è¾¼ã¿
## vuex-module-decoratorã®å°å…¥
æ‰‹é †ã¯[nuxt-typescriptã®å…¬å¼ã‚µã‚¤ãƒˆã«ã‚ã‚‹](https://typescript.nuxtjs.org/ja/cookbook/store)ã®ã§ãã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
å‹å®‰å…¨æ€§ãŒå¼·åŒ–ã•ã‚Œã‚‹ã ã‘ã§ãªãvuexãŒmoduleã¨ã—ã¦åˆ†é›¢ã•ã‚Œã¦ãŸã ã®ã‚¯ãƒ©ã‚¹ã«ãªã‚‹ã®ã§ã€ã¨ã¦ã‚‚ãƒ†ã‚¹ãƒˆã—ã‚„ã™ããªã‚Šã¾ã™ã€‚
ã¾ãŸã€nuxt-typescriptå…¬å¼ã®æ‰‹é †ã«å¾“ã£ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚Œã°vuexã®initializerãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚
```ts:~/utils/store-accessor.ts
/* eslint-disable import/no-mutable-exports */
import { Store } from 'vuex'
import { getModule } from 'vuex-module-decorators'
import MyModule from '~/store/mymodule'
import AuthModule from '~/store/auth'
import ProjectsModule from '~/store/projects'

let mymoduleStore: MyModule
let authStore: AuthModule
let projectsStore: ProjectsModule

function initialiseStores(store: Store<any>): void {
  mymoduleStore = getModule(MyModule, store)
  authStore = getModule(AuthModule, store)
  projectsStore = getModule(ProjectsModule, store)
}

export { initialiseStores, mymoduleStore, authStore, projectsStore }

```
ã“ã¡ã‚‰ã‚’ä½¿ã†ã¨å…ˆã»ã©ã®å®Œæˆç³»ã®ä¾‹ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã”ã¨ã«vuexã®stateã‚’åˆæœŸåŒ–ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€ãƒ†ã‚¹ãƒˆã®é †ç•ªã«ä¾å­˜ã—ãªã„ã‚¯ãƒªãƒ¼ãƒ³ã§å†ç¾æ€§ã®é«˜ã„ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## useFetchã‚’æ‰‹å‹•å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã
ã“ã‚Œã¯å®Œæˆç³»ã®ã‚³ãƒ¡ãƒ³ãƒˆã§æ³¨é‡ˆã—ãŸå†…å®¹ã«ãªã‚Šã¾ã™ãŒã€nuxtæœ¬ä½“ãŒèµ·å‹•ã—ã¦ãªã„é–¢ä¿‚ä¸Šã€`useFetch`ã¯è‡ªå‹•ã§èµ°ã£ã¦ãã‚Œã¾ã›ã‚“ã€‚
ãªã®ã§`setup`ã®ä¸­ã§`fetch`ã‚’æ‰‹å‹•å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ãŸã†ãˆã§ã€returnã«å«ã‚ã¦`vm`çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```ts:Hoge.vue
export default defineComponent({
  setup() {
    const { fetch } = useFetch(async () => {
      ï½ï½
    })
    fetch()
    return { fetch }
  },
})
```

```ts:.spec.ts
    const wrapper = mount(Hoge, {
        mocks: {
            $nuxt: {
                context: {},
            },
        },
    })
    await (wrapper.vm as any).fetch()
```
jestå´ã§`mount`ã—ãŸã‚ã¨`fetch`ã‚’æ‰‹å‹•å®Ÿè¡Œã—ã¦promiseã®è§£æ±ºã‚’å¾…ã¤ã“ã¨ã§ã€`fetch`å®Œäº†å¾Œã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®ã¨ã`this.$nuxt`ãŒç„¡ã„ã¨ã¬ã‚‹ã½ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€ã¨ã‚Šã‚ãˆãšmockã—ã¦ã‚ã’ã¦ãã ã•ã„ã€‚

## asyncDataã®ä¸­èº«ã‚’vmã«å‡ºã—ã¦ãŠã
`asyncData`ã‚‚`fetch`åŒæ§˜ã€jestã§è§£æ±ºã‚’æ¤œå‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã®ã§ã€`asyncData`ã®ä¸­èº«ã‚’`vm`ã«å‡ºã—ã¦ãŠãã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã®éš›ã«`asyncData`ã‚’ä»£ã‚ã‚Šã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ä»•è¾¼ã‚“ã§ãŠãã¾ã™ã€‚
```ts:Fuga.vue
export default defineComponent({
  setup() {
    const fetch = async () => {
        ï½ï½
    }
    const data = useAsync(fetch)
    return { data, fetch }
  },
})
```

```ts:.spec.ts
    const wrapper = mount(Fuga)
    const data = await (wrapper.vm as any).fetch()
    wrapper.vm.$data.value = data
```
## å­å­«ãŒfetchã—ã¦ãŸã‚‰findComponentã§é ‘å¼µã‚‹
```ts:.spec.ts
    test('è¦ªã‚‚å­ä¾›ã‚‚fetchã—ã¦ã‚‹ãƒ†ã‚¹ãƒˆ', async () => {
      const wrapper = mount(projects, {
        mocks: {
          $nuxt: {
            context: {},
          },
        },
      })
      const nameElement = wrapper.find('div.name').element
      await (wrapper.vm as any).fetch()
      const projectComponent = wrapper.findComponent(ProjectsComponent)
      await (projectComponent.vm as any).fetch()
      const projectNameElement =
        projectComponent.find('div.project-name').element
      expect(projectNameElement.innerHTML).toBe('ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ')
      expect(nameElement.innerHTML).toBe('admin')
    })
```
ã¾ãè¦‹ã¦ã®é€šã‚Šã§ã™ãŒã€å­å­«ãŒè‡ªå‰ã§fetchã™ã‚‹ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯`findComponent`ã§è©²å½“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ¢ã—ã¦ã€ã“ã¡ã‚‰ã‚‚ã‚„ã¯ã‚Š`vm`çµŒç”±ã§`fetch`ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
ã¡ã‚ƒã‚“ã¨è§£æ±ºã•ã‚Œã‚Œã°å­å­«è¦ç´ ã®ajaxçµæœã‚‚ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚

# jestå´ã®ä»•è¾¼ã¿
## global setupã®è¨­å®š
ã¾ãšã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯jestã¯`.env`ã‚’èª­ã‚“ã§ãã‚Œãªã„ã®ã§èª­ã‚€ã‚ˆã†ã«ã—ã¾ã™ã€‚
```ts:jest.setup.ts
import dotenv from 'dotenv'
export default function setup() {
  dotenv.config({ path: '.env' })
}
```

nuxtå›ºæœ‰ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å…ˆã«ãƒ¢ãƒƒã‚¯ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
```ts:jest.setup.ts
import dotenv from 'dotenv'
import { config } from '@vue/test-utils'
export default function setup() {
  dotenv.config({ path: '.env' })
  config.stubs.nuxt = { template: '<div />' }
  config.stubs['nuxt-link'] = { template: '<a><slot /></a>' }
  config.stubs['no-ssr'] = { template: '<span><slot /></span>' }
}
```
## configã®è¨­å®š
åŸºæœ¬[create-nuxt-app](https://ja.nuxtjs.org/docs/2.x/get-started/installation)ã§ç”Ÿæˆã•ã‚Œã‚‹ã‚‚ã®ã‚’ä½¿ãˆã°ã„ã„ã§ã™ãŒã€scssã‚„ç”»åƒã¯ãƒ¢ãƒƒã‚¯ã—ã¦ãŠã‹ãªã„ã¨é¢å€’ãªã®ã§[jest-transform-stub](https://www.npmjs.com/package/jest-transform-stub)ã‚’ä½¿ã£ã¦ãƒ¢ãƒƒã‚¯ã—ã¦ãŠãã¾ã™ã€‚
```bash
npm install --save-dev jest-transform-stub
```
```js:jest.config.js
module.exports = {
  transform: {
    '^.+\\.(css|styl|less|sass|scss|png|jpg|ttf|woff|woff2)$':
      'jest-transform-stub',
  },
}
```
## useStoreã‚’ä½¿ã†
ä¾‹ã«ã‚ˆã£ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„ã®ã§ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§`useStore`ã™ã‚‹å ´åˆã¯`$store`ã«`store`ã‚’æµã—è¾¼ã¿ã¾ã™ã€‚ç§ãŒè©¦ã—ãŸé™ã‚Šä½•æ•…ã‹`localVue`ã«`vuex`ã‚’æ¸¡ã™æ–¹æ³•ã˜ã‚ƒã†ã¾ãã„ãã¾ã›ã‚“ã§ã—ãŸã€‚
`usoStore`ã›ãšç›´æ¥å„storeã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹å ´åˆã¯ä¸è¦ã§ã™ã€‚
```ts
import { mount } from '@vue/test-utils'
import { createStore } from '~/.nuxt/store'
import { initialiseStores } from '~/utils/store-accessor'
import index from '@/pages/index.vue'
const store = createStore()
describe('index page', () => {
  beforeEach(() => {
    initialiseStores(store)
  })
  describe('index', () => {
    test('index page', async () => {
      const wrapper = mount(index, {
        mocks: {
          $nuxt: {
            context: {},
          },
          $store: store,
        },
      })
    })
  })
})
```

# ã¾ã¨ã‚
nuxtã¯è‰²ã€…ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã¹ã£ãŸã‚Šã§è‰²ã€…ã†ã£ã¨ã†ã—ã„ã§ã™ãŒã€CIã§AJAXéƒ¨åˆ†ã®ãƒ†ã‚¹ãƒˆãŒãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒã˜çŠ¶æ…‹ã§å›ã›ã‚‹ã®ã¯ãªã‹ãªã‹æ„Ÿå‹•çš„ã§ã™ã€‚
ä»Šå¾Œã‚‚è‰²ã€…èª¿æŸ»æ¤œè¨ã—ã¦ã‚‚ã£ã¨ç°¡å˜ã«ãƒ†ã‚¹ãƒˆã§ããªã„ã‹èª¿ã¹ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚